<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Pixel Vacuum Pro: Infinity</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { 
            --game-bg: #050505; 
            --accent: #22d3ee; 
            --gold: #facc15; 
            --danger: #ef4444; 
            --body-bg: #000;
            --card-bg: rgba(255, 255, 255, 0.08);
            --text-main: #ffffff;
        }

        /* –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞ */
        body.light-theme {
            --body-bg: #f0f0f0;
            --card-bg: rgba(0, 0, 0, 0.05);
            --text-main: #000000;
        }
        
        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
            user-select: none; 
            outline: none; 
        }

        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            overflow: hidden; position: fixed; 
            background-color: var(--body-bg); 
            display: flex; align-items: center; justify-content: center; 
            touch-action: none; overscroll-behavior: none;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            transition: background-color 0.3s;
        }

        #game-wrapper {
            position: relative;
            /* –ë–æ–ª—å—à–µ –æ—Ç—Å—Ç—É–ø —Å–Ω–∏–∑—É (80px –≤–º–µ—Å—Ç–æ 30) –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –∂–µ—Å—Ç–æ–≤ */
            width: calc(100% - 20px);
            height: calc(100% - 80px); 
            margin-bottom: 40px; 
            background: var(--game-bg);
            border-radius: 32px;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }

        canvas { display: block; width: 100%; height: 100%; }

        .ui-layer { position: absolute; inset: 0; pointer-events: none; z-index: 10; }
        
        .top-bar { 
            position: absolute; top: 20px; left: 0; right: 0; 
            display: flex; justify-content: space-between; padding: 0 15px; 
            align-items: flex-start;
        }
        
        .stat-card { 
            background: var(--card-bg); backdrop-filter: blur(10px); 
            padding: 8px 10px; border-radius: 14px; border: 1px solid rgba(255,255,255,0.1);
            min-width: 70px; text-align: center; color: var(--text-main);
        }
        .stat-label { font-size: 9px; opacity: 0.6; font-weight: 900; letter-spacing: 0.5px; margin-bottom: 2px; }
        .stat-value { font-size: 15px; font-weight: 800; }

        .bag-system { 
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%); 
            width: 100px; text-align: center; 
        }
        .bag-bar-bg { 
            width: 100%; height: 8px; background: rgba(255,255,255,0.1); 
            border-radius: 4px; margin-top: 5px; overflow: hidden; 
        }
        #bag-fill-w { width: 0%; height: 100%; background: var(--accent); transition: width 0.2s; }

        .combo-info { position: absolute; top: 90px; left: 20px; }
        #combo-txt { 
            font-size: 36px; font-weight: 900; color: var(--accent); 
            text-shadow: 0 0 15px rgba(34,211,238,0.5); display: none; 
            font-style: italic;
        }
        .best-score { font-size: 10px; color: rgba(255,255,255,0.4); font-weight: bold; }

        .controls { 
            position: absolute; bottom: 25px; left: 0; right: 0; 
            display: flex; justify-content: center; gap: 12px; pointer-events: auto; 
        }
        
        .btn {
            width: 64px; height: 64px; border-radius: 50%; border: none;
            background: rgba(255,255,255,0.12); backdrop-filter: blur(10px);
            color: white; display: flex; flex-direction: column; align-items: center; justify-content: center;
            border: 1px solid rgba(255,255,255,0.1); transition: 0.2s;
        }
        .btn:active { transform: scale(0.9); background: rgba(255,255,255,0.2); }
        .btn-price { font-size: 10px; font-weight: 800; color: var(--gold); }
        .btn-name { font-size: 7px; opacity: 0.8; font-weight: bold; margin-bottom: 2px; }

        .can-afford { animation: pulse-gold 1.5s infinite; border-color: var(--gold) !important; }
        @keyframes pulse-gold { 
            0% { box-shadow: 0 0 0 0 rgba(250, 204, 21, 0.4); }
            70% { box-shadow: 0 0 15px 5px rgba(250, 204, 21, 0); }
            100% { box-shadow: 0 0 0 0 rgba(250, 204, 21, 0); }
        }
        .btn-turbo.active { background: var(--danger); box-shadow: 0 0 25px var(--danger); border-color: white; }
        
        #notif { 
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); 
            color: white; font-weight: 900; font-size: 36px; text-align: center;
            pointer-events: none; z-index: 100; display: none;
        }
        .animate-notif { display: block; animation: notifAnim 1.5s forwards; }
        @keyframes notifAnim { 
            0% { opacity: 0; transform: translate(-50%, -30%) scale(0.5); } 
            20% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); } 
            100% { opacity: 0; transform: translate(-50%, -70%) scale(1.2); } 
        }
    </style>
</head>
<body>
    <div id="game-wrapper">
        <canvas id="gameCanvas"></canvas>
        <div id="ui" class="ui-layer">
            <div class="top-bar">
                <div class="stat-card"><div class="stat-label">RANK</div><div class="stat-value" id="lvl">1</div></div>
                <div class="bag-system">
                    <div class="stat-label" style="color:white; opacity: 1;">BAG <span id="bag-txt">0</span>%</div>
                    <div class="bag-bar-bg"><div id="bag-fill-w"></div></div>
                </div>
                <div class="stat-card"><div class="stat-label">COINS</div><div class="stat-value" id="coins" style="color:var(--gold)">0</div></div>
            </div>

            <div class="combo-info">
                <div id="combo-txt">x0</div>
                <div class="best-score">BEST: x<span id="best-combo">0</span></div>
            </div>

            <div class="controls">
                <button class="btn" onclick="upgrade('power')" id="btn-power">
                    <span>üí™</span><div class="btn-name">POWER</div><div class="btn-price" id="p-price">50</div>
                </button>
                <button class="btn btn-turbo" onclick="activateTurbo()" id="btn-turbo">
                    <span>‚ö°</span><div class="btn-name">TURBO</div><div class="btn-price" id="t-price">100</div>
                </button>
                <button class="btn" onclick="upgrade('radius')" id="btn-radius">
                    <span>üîç</span><div class="btn-name">RADIUS</div><div class="btn-price" id="r-price">75</div>
                </button>
            </div>
        </div>
        <div id="notif"></div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();
        
        // –ö–ª—é—á–µ–≤–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞: –æ—Ç–∫–ª—é—á–∞–µ–º —Å–≤–∞–π–ø—ã –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è
        if (tg.disableVerticalSwipes) tg.disableVerticalSwipes();

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const COLORS = ['#22d3ee', '#4ade80', '#fb7185', '#fbbf24', '#a78bfa', '#f472b6'];

        const MAX_POWER_LVL = 50;
        const MAX_RADIUS_LVL = 20;

        let state = JSON.parse(localStorage.getItem('pixel_vaccum_inf_v2')) || {
            level: 1, coins: 0, pLvl: 0, rLvl: 0, tPrice: 100, bestCombo: 0, totalCleared: 0
        };

        let pixels = [], powerups = [];
        let mouse = { x: -100, y: -100, down: false };
        let combo = 0, comboTimer = 0, bagFill = 0, isOverheating = false;
        let lastTime = performance.now(), spawnAcc = 0, isTurbo = false, activeMagnet = 0;

        // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ç–µ–º—ã Telegram
        function applyTheme() {
            if (tg.colorScheme === 'light') {
                document.body.classList.add('light-theme');
            } else {
                document.body.classList.remove('light-theme');
            }
        }

        function init() {
            applyTheme();
            tg.onEvent('themeChanged', applyTheme);
            window.addEventListener('resize', resize);
            resize();
            for(let i=0; i<100; i++) spawnPixel(true);
            requestAnimationFrame(loop);
        }

        function resize() {
            const rect = canvas.parentElement.getBoundingClientRect();
            canvas.width = rect.width; canvas.height = rect.height;
        }

        function spawnPixel() {
            const margin = 30;
            const isHeavy = Math.random() < Math.min(0.05 + state.level * 0.01, 0.25);
            const isGold = Math.random() < 0.03;
            pixels.push({
                x: margin + Math.random() * (canvas.width - margin * 2),
                y: margin + Math.random() * (canvas.height - margin * 2),
                gold: isGold, heavy: isHeavy, mass: isHeavy ? 2.8 : 1,
                color: isHeavy ? '#4b5563' : (isGold ? '#facc15' : COLORS[Math.floor(Math.random()*COLORS.length)])
            });
        }

        function addMessage(txt) {
            const el = document.getElementById('notif');
            el.innerText = txt; el.classList.remove('animate-notif');
            void el.offsetWidth; el.classList.add('animate-notif');
        }

        function upgrade(type) {
            if (type === 'power' && state.pLvl >= MAX_POWER_LVL) return;
            if (type === 'radius' && state.rLvl >= MAX_RADIUS_LVL) return;
            let cost = (type === 'power') ? Math.floor(50 * Math.pow(1.8, state.pLvl)) : Math.floor(75 * Math.pow(2.3, state.rLvl));
            if(state.coins >= cost) {
                state.coins -= cost;
                if(type === 'power') state.pLvl++; else state.rLvl++;
                if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');
                save();
            }
        }

        function activateTurbo() {
            if(state.coins >= state.tPrice && !isTurbo && !isOverheating) {
                state.coins -= state.tPrice;
                state.tPrice = Math.floor(state.tPrice * 1.6);
                isTurbo = true;
                addMessage("üî• –£–õ–¨–¢–†–ê!");
                if(tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
                setTimeout(() => { isTurbo = false; }, 6000);
            }
        }

        function loop(t) {
            const dt = Math.min((t - lastTime) / 1000, 0.1);
            lastTime = t;

            ctx.fillStyle = '#050505';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            if(bagFill >= 100 && !isOverheating) {
                isOverheating = true; combo = 0;
                addMessage("–ü–ï–†–ï–ì–†–ï–í! ‚ö†Ô∏è");
                if(tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('error');
            }
            if(isOverheating) {
                bagFill -= dt * 22;
                if(bagFill <= 0) { bagFill = 0; isOverheating = false; }
            } else {
                bagFill = Math.max(0, bagFill - dt * 2.5);
            }

            if(comboTimer > 0) {
                comboTimer -= dt;
                if(comboTimer <= 0) combo = 0;
            }
            if(activeMagnet > 0) activeMagnet -= dt;

            spawnAcc += dt;
            if(spawnAcc > 0.25) {
                if(pixels.length < 200) spawnPixel();
                if(Math.random() < 0.01) powerups.push({
                    x: 60+Math.random()*(canvas.width-120), y: 60+Math.random()*(canvas.height-120),
                    type: Math.random() > 0.5 ? 'üß≤' : '‚ùÑÔ∏è', life: 7
                });
                spawnAcc = 0;
            }

            const suctionBase = (1.0 + Math.log10(state.pLvl + 1) * 1.6) * (isOverheating ? 0.3 : (isTurbo ? 3.0 : 1.0));
            let rad = (55 + state.rLvl * 12);
            if(activeMagnet > 0) rad *= 1.5;
            const rad2 = rad * rad;

            if(mouse.down && !isOverheating) {
                ctx.beginPath();
                let g = ctx.createRadialGradient(mouse.x, mouse.y, 0, mouse.x, mouse.y, rad);
                g.addColorStop(0, isTurbo ? 'rgba(239,68,68,0.2)' : 'rgba(34,211,238,0.1)');
                g.addColorStop(1, 'transparent');
                ctx.fillStyle = g;
                ctx.arc(mouse.x, mouse.y, rad, 0, Math.PI*2); ctx.fill();
            }

            for(let i=pixels.length-1; i>=0; i--) {
                let p = pixels[i];
                let dx = mouse.x - p.x, dy = mouse.y - p.y;
                let d2 = dx*dx + dy*dy;

                if(mouse.down && !isOverheating && d2 < rad2) {
                    let d = Math.sqrt(d2) || 1;
                    let f = (suctionBase / p.mass) * 220 * dt;
                    p.x += (dx/d)*f; p.y += (dy/d)*f;
                    if(d < 12) {
                        pixels.splice(i, 1);
                        combo++; comboTimer = 2.0;
                        state.totalCleared++;
                        bagFill += p.heavy ? 2.5 : 0.8;
                        if(isTurbo) bagFill += 0.5;
                        let mult = 1 + Math.floor(combo/10)*0.2;
                        state.coins += (p.gold ? 10 : 1) * mult;
                        if(combo > state.bestCombo) state.bestCombo = combo;
                        if(state.totalCleared % 150 === 0) {
                            state.level++;
                            addMessage(`–†–ê–ù–ì ${state.level}`);
                        }
                        continue;
                    }
                }
                ctx.fillStyle = p.color;
                ctx.fillRect(p.x-2, p.y-2, 4, 4);
            }

            ctx.textAlign = "center";
            for(let i=powerups.length-1; i>=0; i--) {
                let pw = powerups[i]; pw.life -= dt;
                let dx = mouse.x - pw.x, dy = mouse.y - pw.y;
                if(mouse.down && (dx*dx+dy*dy) < 1300) {
                    if(pw.type === 'üß≤') activeMagnet = 8;
                    else { bagFill = Math.max(0, bagFill - 50); comboTimer += 1.5; }
                    addMessage(pw.type === 'üß≤' ? "–ú–ê–ì–ù–ò–¢ üß≤" : "–•–û–õ–û–î ‚ùÑÔ∏è");
                    powerups.splice(i, 1); continue;
                }
                if(pw.life <= 0) { powerups.splice(i, 1); continue; }
                ctx.font = "26px Arial"; ctx.fillText(pw.type, pw.x, pw.y);
            }

            updateUI();
            requestAnimationFrame(loop);
        }

        function updateUI() {
            document.getElementById('lvl').innerText = state.level;
            document.getElementById('coins').innerText = Math.floor(state.coins);
            document.getElementById('best-combo').innerText = state.bestCombo;
            
            const btnP = document.getElementById('btn-power');
            if(state.pLvl >= MAX_POWER_LVL) btnP.style.display = 'none';
            else {
                const cost = Math.floor(50 * Math.pow(1.8, state.pLvl));
                document.getElementById('p-price').innerText = cost;
                btnP.classList.toggle('can-afford', state.coins >= cost);
            }

            const btnR = document.getElementById('btn-radius');
            if(state.rLvl >= MAX_RADIUS_LVL) btnR.style.display = 'none';
            else {
                const cost = Math.floor(75 * Math.pow(2.3, state.rLvl));
                document.getElementById('r-price').innerText = cost;
                btnR.classList.toggle('can-afford', state.coins >= cost);
            }

            const btnT = document.getElementById('btn-turbo');
            document.getElementById('t-price').innerText = state.tPrice;
            btnT.classList.toggle('can-afford', state.coins >= state.tPrice && !isTurbo);
            btnT.classList.toggle('active', isTurbo);

            document.getElementById('bag-txt').innerText = Math.floor(bagFill);
            const bFill = document.getElementById('bag-fill-w');
            bFill.style.width = bagFill + '%';
            bFill.style.background = isOverheating ? 'var(--danger)' : (bagFill > 80 ? 'var(--gold)' : 'var(--accent)');

            const cUI = document.getElementById('combo-txt');
            if(combo > 1) {
                cUI.innerText = 'x' + combo;
                cUI.style.display = 'block';
                cUI.style.transform = `scale(${1 + Math.min(combo/100, 0.4)})`;
            } else {
                cUI.style.display = 'none';
            }
        }

        function save() { localStorage.setItem('pixel_vaccum_inf_v2', JSON.stringify(state)); }
        
        function handlePointer(e) {
            const rect = canvas.getBoundingClientRect();
            const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
            const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
            mouse.x = x; mouse.y = y;
        }

        window.addEventListener('pointerdown', e => { mouse.down = true; handlePointer(e); });
        window.addEventListener('pointermove', handlePointer);
        window.addEventListener('pointerup', () => { mouse.down = false; save(); });
        
        init();
    </script>
</body>
</html>
