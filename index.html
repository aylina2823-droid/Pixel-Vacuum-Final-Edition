<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Pixel Vacuum Pro: Prestige</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --game-bg: #050505;
            --accent: #22d3ee;
            --gold: #facc15;
            --danger: #ef4444;
            --tg-bg: #000;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            touch-action: none;
            overscroll-behavior: none;
        }

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; position: fixed;
            background-color: var(--tg-bg);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        #game-wrapper {
            position: relative;
            width: calc(100% - 20px);
            height: calc(100% - 100px);
            background: var(--game-bg);
            border-radius: 32px;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }

        canvas { display: block; width: 100%; height: 100%; }

        .ui-layer { position: absolute; inset: 0; pointer-events: none; z-index: 10; }
        
        /* Top Bar */
        .top-bar {
            position: absolute; top: 20px; left: 0; right: 0;
            display: flex; justify-content: space-between; padding: 0 15px;
        }
        .stat-card {
            background: rgba(255,255,255,0.08); backdrop-filter: blur(10px);
            padding: 8px 12px; border-radius: 14px; border: 1px solid rgba(255,255,255,0.1);
            min-width: 70px; text-align: center; color: white;
        }
        .stat-label { font-size: 8px; opacity: 0.6; font-weight: 900; margin-bottom: 2px; }
        .stat-value { font-size: 14px; font-weight: 800; color: #fff; }

        /* Controls */
        .controls {
            position: absolute; bottom: 25px; left: 0; right: 0;
            display: flex; justify-content: center; gap: 12px; pointer-events: auto;
        }
        .btn {
            width: 70px; height: 70px; border-radius: 20px; border: none;
            background: rgba(255,255,255,0.1); backdrop-filter: blur(10px);
            color: white; display: flex; flex-direction: column; align-items: center; justify-content: center;
            border: 1px solid rgba(255,255,255,0.1); transition: 0.2s;
        }
        .btn:active { transform: scale(0.9); background: rgba(255,255,255,0.2); }
        .btn-label { font-size: 7px; font-weight: 900; opacity: 0.8; margin-top: 4px; text-align: center; }
        .btn-price { font-size: 10px; font-weight: 800; color: var(--gold); }
        
        .can-afford { border-color: var(--gold); box-shadow: 0 0 15px rgba(250, 204, 21, 0.2); }
        .prestige-btn { background: linear-gradient(135deg, #a855f7, #6366f1); border: none; }

        #notif {
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
            color: white; font-weight: 900; font-size: 32px; pointer-events: none; z-index: 100; display: none;
            text-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        .animate-notif { display: block; animation: notifAnim 1.5s forwards; }
        @keyframes notifAnim { 0% { opacity:0; scale:0.5; } 20% { opacity:1; scale:1.1; } 100% { opacity:0; transform: translate(-50%, -80%) scale(1.2); } }
    </style>
</head>
<body>
    <div id="game-wrapper">
        <canvas id="gameCanvas"></canvas>
        <div id="ui" class="ui-layer">
            <div class="top-bar">
                <div class="stat-card"><div class="stat-label">RANK</div><div class="stat-value" id="rank-val">1</div></div>
                <div class="stat-card"><div class="stat-label">COINS</div><div class="stat-value" id="coins-val" style="color:var(--gold)">0</div></div>
            </div>
            <div class="controls">
                <button class="btn" onclick="upgrade('power')" id="btn-power">
                    <span id="p-icon">üí™</span><div class="btn-label" id="p-label">–°–ò–õ–ê</div><div class="btn-price" id="p-price">50</div>
                </button>
                <button class="btn" onclick="activateTurbo()" id="btn-turbo">
                    <span>‚ö°</span><div class="btn-label">–¢–£–†–ë–û</div><div class="btn-price" id="t-price">100</div>
                </button>
                <button class="btn" onclick="upgrade('radius')" id="btn-radius">
                    <span id="r-icon">üîç</span><div class="btn-label" id="r-label">–†–ê–î–ò–£–°</div><div class="btn-price" id="r-price">75</div>
                </button>
            </div>
        </div>
        <div id="notif"></div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();
        if (tg.disableVerticalSwipes) tg.disableVerticalSwipes();

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const COLORS = ['#22d3ee', '#4ade80', '#fb7185', '#fbbf24', '#a78bfa'];

        // --- Game State ---
        let state = JSON.parse(localStorage.getItem('pixel_vac_prestige_v1')) || {
            rank: 1, coins: 0, pLvl: 0, rLvl: 0, magnetLvl: 0, tPrice: 100
        };

        const OFFSET_Y = 75; // –í–∏–∑—É–∞–ª—å–Ω—ã–π –æ—Ñ—Å–µ—Ç –≤—ã—à–µ –ø–∞–ª—å—Ü–∞
        const RADIUS_CAP_RATIO = 0.35; // 35% —ç–∫—Ä–∞–Ω–∞
        const MAX_POWER_VAL = 10.0;
        
        let pixels = [], clumps = [], mouse = { x: -100, y: -100, down: false };
        let lastTime = performance.now(), spawnAcc = 0, isTurbo = false;

        function syncTheme() {
            const bg = tg.themeParams.bg_color || (tg.colorScheme === 'dark' ? '#000000' : '#ffffff');
            document.documentElement.style.setProperty('--tg-bg', bg);
            tg.setBackgroundColor(bg);
            tg.setHeaderColor(bg);
        }

        function init() {
            syncTheme();
            tg.onEvent('themeChanged', syncTheme);
            window.addEventListener('resize', resize);
            resize();
            
            // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ —Å–∫—Ä–æ–ª–ª–∞
            document.addEventListener('touchmove', e => e.preventDefault(), { passive: false });
            
            for(let i=0; i<60; i++) spawnPixel();
            requestAnimationFrame(loop);
        }

        function resize() {
            const rect = canvas.parentElement.getBoundingClientRect();
            canvas.width = rect.width; canvas.height = rect.height;
        }

        // --- Mechanics ---
        function spawnPixel() {
            pixels.push({
                x: Math.random()*canvas.width, y: Math.random()*canvas.height,
                color: COLORS[Math.floor(Math.random()*COLORS.length)],
                gold: Math.random() < 0.02
            });
        }

        function spawnClump() {
            const cx = Math.random()*canvas.width, cy = Math.random()*canvas.height;
            const size = 5 + Math.floor(Math.random()*5);
            const clump = { x: cx, y: cy, resistance: 2.0, parts: [] };
            for(let i=0; i<size; i++) {
                clump.parts.push({ dx: (Math.random()-0.5)*12, dy: (Math.random()-0.5)*12 });
            }
            clumps.push(clump);
        }

        function getPower() {
            let base = 1.0 + Math.log10(state.pLvl + 1) * 2;
            return Math.min(base, MAX_POWER_VAL);
        }

        function getRadius() {
            let base = 50 + state.rLvl * 10;
            return Math.min(base, canvas.width * RADIUS_CAP_RATIO);
        }

        function upgrade(type) {
            if(type === 'power') {
                const currentP = getPower();
                if(currentP >= MAX_POWER_VAL) {
                    // –ü–†–ï–°–¢–ò–ñ
                    state.rank++;
                    state.pLvl = 0;
                    state.coins = 0; // –°–±—Ä–æ—Å –ø—Ä–∏ –ø—Ä–µ—Å—Ç–∏–∂–µ
                    addMessage(`–†–ê–ù–ì ${state.rank}! üéñÔ∏è`);
                    if(tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
                } else {
                    let cost = Math.floor(50 * Math.pow(1.6, state.pLvl));
                    if(state.coins >= cost) {
                        state.coins -= cost; state.pLvl++;
                    }
                }
            } else {
                const rad = getRadius();
                if(rad >= canvas.width * RADIUS_CAP_RATIO) {
                    // –ú–ê–ì–ù–ï–¢–ò–ó–ú
                    let cost = Math.floor(500 * Math.pow(2, state.magnetLvl));
                    if(state.coins >= cost) {
                        state.coins -= cost; state.magnetLvl++;
                    }
                } else {
                    let cost = Math.floor(75 * Math.pow(1.8, state.rLvl));
                    if(state.coins >= cost) {
                        state.coins -= cost; state.rLvl++;
                    }
                }
            }
            save();
        }

        function activateTurbo() {
            if(state.coins >= state.tPrice && !isTurbo) {
                state.coins -= state.tPrice;
                state.tPrice = Math.floor(state.tPrice * 1.5);
                isTurbo = true;
                if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');
                addMessage("–£–õ–¨–¢–†–ê! üî•");
                setTimeout(() => isTurbo = false, 5000);
            }
        }

        function loop(t) {
            const dt = Math.min((t - lastTime)/1000, 0.1);
            lastTime = t;
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // –í–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Å–∞—Å—ã–≤–∞–Ω–∏—è
            const targetX = mouse.x;
            const targetY = mouse.y - OFFSET_Y;

            spawnAcc += dt;
            if(spawnAcc > 0.4) {
                if(pixels.length < 150) spawnPixel();
                if(Math.random() < 0.05 && clumps.length < 3) spawnClump();
                spawnAcc = 0;
            }

            const power = getPower() * (isTurbo ? 3.5 : 1.0) * (1 + state.magnetLvl * 0.5);
            const radius = getRadius();
            const radSq = radius * radius;
            const maxVelocity = 12; // –õ–∏–º–∏—Ç —Å–∫–æ—Ä–æ—Å—Ç–∏ –¥–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç–∏

            // Draw Radius Visual
            if(mouse.down) {
                const grad = ctx.createRadialGradient(targetX, targetY, 0, targetX, targetY, radius);
                grad.addColorStop(0, isTurbo ? 'rgba(239, 68, 68, 0.2)' : 'rgba(34, 211, 238, 0.15)');
                grad.addColorStop(1, 'transparent');
                ctx.fillStyle = grad;
                ctx.beginPath(); ctx.arc(targetX, targetY, radius, 0, Math.PI*2); ctx.fill();
            }

            // Pixels Logic
            for(let i=pixels.length-1; i>=0; i--) {
                let p = pixels[i];
                let dx = targetX - p.x, dy = targetY - p.y;
                let d2 = dx*dx + dy*dy;

                if(mouse.down && d2 < radSq) {
                    let d = Math.sqrt(d2) || 1;
                    let force = (power * 200 * dt);
                    let vx = (dx/d) * force;
                    let vy = (dy/d) * force;

                    // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏ (–ü–æ—Ç–æ–∫–æ–≤–æ—Å—Ç—å)
                    p.x += Math.max(Math.min(vx, maxVelocity), -maxVelocity);
                    p.y += Math.max(Math.min(vy, maxVelocity), -maxVelocity);

                    if(d < 10) {
                        state.coins += (p.gold ? 15 : 1) * state.rank;
                        pixels.splice(i, 1); continue;
                    }
                }
                ctx.fillStyle = p.gold ? '#facc15' : p.color;
                ctx.fillRect(p.x-2, p.y-2, 4, 4);
            }

            // Clumps Logic
            for(let i=clumps.length-1; i>=0; i--) {
                let c = clumps[i];
                let dx = targetX - c.x, dy = targetY - c.y;
                let d2 = dx*dx + dy*dy;

                if(mouse.down && d2 < radSq) {
                    c.resistance -= dt * (power/2);
                    // –°–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ: –∫–æ–º–æ–∫ –¥—Ä–æ–∂–∏—Ç
                    c.x += (Math.random()-0.5)*4;
                    c.y += (Math.random()-0.5)*4;
                    
                    if(c.resistance <= 0) {
                        state.coins += 25 * state.rank;
                        if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');
                        clumps.splice(i, 1); continue;
                    }
                    // –ü–ª–∞–≤–Ω–æ–µ –ø—Ä–∏—Ç—è–∂–µ–Ω–∏–µ –∫–æ–º–∫–∞
                    let d = Math.sqrt(d2) || 1;
                    c.x += (dx/d) * 2; c.y += (dy/d) * 2;
                }
                
                ctx.fillStyle = '#6b7280';
                c.parts.forEach(pt => {
                    ctx.fillRect(c.x + pt.dx - 2, c.y + pt.dy - 2, 5, 5);
                });
            }

            updateUI();
            requestAnimationFrame(loop);
        }

        function updateUI() {
            document.getElementById('rank-val').innerText = state.rank;
            document.getElementById('coins-val').innerText = Math.floor(state.coins);

            // Power Button Evolution
            const pBtn = document.getElementById('btn-power');
            const currentP = getPower();
            if(currentP >= MAX_POWER_VAL) {
                pBtn.classList.add('prestige-btn');
                document.getElementById('p-label').innerText = "–ü–†–ï–°–¢–ò–ñ";
                document.getElementById('p-price').innerText = "–°–ë–†–û–°";
                pBtn.classList.add('can-afford');
            } else {
                pBtn.classList.remove('prestige-btn');
                document.getElementById('p-label').innerText = "–°–ò–õ–ê";
                let cost = Math.floor(50 * Math.pow(1.6, state.pLvl));
                document.getElementById('p-price').innerText = cost;
                pBtn.classList.toggle('can-afford', state.coins >= cost);
            }

            // Radius Button Evolution
            const rBtn = document.getElementById('btn-radius');
            if(getRadius() >= canvas.width * RADIUS_CAP_RATIO) {
                document.getElementById('r-label').innerText = "–ú–ê–ì–ù–ï–¢–ò–ó–ú";
                let cost = Math.floor(500 * Math.pow(2, state.magnetLvl));
                document.getElementById('r-price').innerText = cost;
                rBtn.classList.toggle('can-afford', state.coins >= cost);
            } else {
                document.getElementById('r-label').innerText = "–†–ê–î–ò–£–°";
                let cost = Math.floor(75 * Math.pow(1.8, state.rLvl));
                document.getElementById('r-price').innerText = cost;
                rBtn.classList.toggle('can-afford', state.coins >= cost);
            }

            const tBtn = document.getElementById('btn-turbo');
            document.getElementById('t-price').innerText = state.tPrice;
            tBtn.classList.toggle('can-afford', state.coins >= state.tPrice);
        }

        function addMessage(txt) {
            const el = document.getElementById('notif');
            el.innerText = txt; el.classList.remove('animate-notif');
            void el.offsetWidth; el.classList.add('animate-notif');
        }

        function save() { localStorage.setItem('pixel_vac_prestige_v1', JSON.stringify(state)); }

        function handlePointer(e) {
            const rect = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            mouse.x = clientX - rect.left;
            mouse.y = clientY - rect.top;
        }

        window.addEventListener('pointerdown', e => { mouse.down = true; handlePointer(e); e.preventDefault(); });
        window.addEventListener('pointermove', e => { handlePointer(e); e.preventDefault(); });
        window.addEventListener('pointerup', () => { mouse.down = false; save(); });

        init();
    </script>
</body>
</html>